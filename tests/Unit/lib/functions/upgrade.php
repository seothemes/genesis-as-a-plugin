<?php
/**
 * Genesis Framework.
 *
 * WARNING: This file is part of the core Genesis Framework. DO NOT edit this file under any circumstances.
 * Please do all modifications in the form of a child theme.
 *
 * @package StudioPress\Genesis
 * @author  StudioPress
 * @license GPL-2.0-or-later
 * @link    https://my.studiopress.com/themes/genesis/
 */

namespace StudioPress\Genesis\Tests\Unit;

use Brain\Monkey\Functions;
use Mockery;

/**
 * Test upgrade functions.
 *
 * @group upgrade
 */
class Upgrade extends TestCase {
	/**
	 * Test that Genesis post-update won't run if an update hasn't been executed.
	 */
	public function test_genesis_update_complete_no_update() {
		genesis_update_complete(
			null,
			[
				'action' => 'notupdate',
			]
		);

		Functions\expect( 'wp_remote_post' )->never();
	}

	/**
	 * Test that Genesis post-update won't run if a theme update hasn't been executed.
	 */
	public function test_genesis_update_complete_not_a_theme() {
		genesis_update_complete(
			null,
			[
				'action' => 'update',
				'type'   => 'plugin',
			]
		);

		Functions\expect( 'wp_remote_post' )->never();
	}

	/**
	 * Test that Genesis post-update won't run if Genesis hasn't been updated.
	 */
	public function test_genesis_update_complete_genesis_not_updated() {
		Functions\when( 'admin_url' )->justReturn();
		Functions\when( 'add_query_arg' )->justReturn();
		Functions\when( 'wp_remote_get' )->justReturn();

		genesis_update_complete(
			null,
			[
				'action' => 'update',
				'type'   => 'theme',
				'themes' => [
					'twentynineteen',
					'banana',
				],
			]
		);

		Functions\expect( 'wp_remote_post' )->never();
	}

	/**
	 * Test that Genesis post-update runs when Genesis is updated.
	 */
	public function test_genesis_update_complete_genesis_updated() {
		Functions\when( 'admin_url' )->justReturn();
		Functions\when( 'add_query_arg' )->justReturn();
		Functions\expect( 'wp_remote_get' )->once();

		genesis_update_complete(
			null,
			[
				'action' => 'update',
				'type'   => 'theme',
				'themes' => [
					'genesis',
					'twentynineteen',
					'banana',
				],
			]
		);
	}

	/**
	 * Test that clearing the update transient deletes the transient and removes update nag.
	 */
	public function test_genesis_clear_update_transient() {
		Functions\expect( 'delete_option' )->once()->with( 'genesis_expiring_setting_update' );

		Functions\expect( 'remove_action' )->with( 'admin_notices', 'genesis_update_nag' )->once();

		\genesis_clear_update_transient();
	}

	/**
	 * Test latest db upgrade.
	 */
	public function test_genesis_upgrade_db_latest() {
		Functions\expect( 'genesis_update_settings' )->with(
			[
				'theme_version' => PARENT_THEME_VERSION,
				'db_version'    => PARENT_DB_VERSION,
				'upgrade'       => '1',
			]
		)->once();

		\genesis_upgrade_db_latest();
	}
}
