<?php
/**
 * Genesis Framework.
 *
 * WARNING: This file is part of the core Genesis Framework. DO NOT edit this file under any circumstances.
 * Please do all modifications in the form of a child theme.
 *
 * @package StudioPress\Genesis\Tests\System
 * @author  XWP, Google, StudioPress, and contributors
 * @license GPL-2.0-or-later
 * @link    https://github.com/studiopress/genesis-amp
 */

namespace StudioPress\Genesis\Tests\System;

use Brain\Monkey\Functions;
use StudioPress\Genesis\Upgrade\Upgrade_DB_3001 as Upgrader;

/**
 * Test Upgrade_DB_3001.
 */
class Upgrade_DB_3001_Test extends TestCase {
	/**
	 * Holds the IDs of the created pages.
	 *
	 * @var array Page IDs created by WP Test.
	 */
	protected $page_ids;

	/**
	 * Blog page settings to use during the conversion.
	 *
	 * @var array Settings.
	 */
	protected $blog_page_settings;

	/**
	 * Prepares the test environment before each test.
	 */
	public function setUp() {
		$this->page_ids = $this->factory->post->create_many(
			2,
			[
				'post_type'  => 'page',
				'meta_input' => [
					'_wp_page_template' => 'page_blog.php',
				],
			]
		);

		$this->blog_page_settings = [
			'blog_cat'         => '32',
			'blog_cat_exclude' => '76,98',
			'blog_cat_num'     => '154',
		];

		genesis_update_settings( $this->blog_page_settings );
	}

	/**
	 * Test that the upgrade updates the settings.
	 */
	public function test_blog_page_template_used() {
		( new Upgrader() )->migrate_blog_pages();

		$expected_query_args = [
			'cat'              => $this->blog_page_settings['blog_cat'],
			'category__not_in' => $this->blog_page_settings['blog_cat_exclude'],
			'showposts'        => $this->blog_page_settings['blog_cat_num'],
		];

		foreach ( $this->page_ids as $page_id ) {
			$this->assertEquals( urldecode( http_build_query( $expected_query_args ) ), get_post_meta( $page_id, 'query_args', true ) );
			$this->assertEquals( 'page_blog.php', get_post_meta( $page_id, '_wp_page_template', true ) );
		}
	}
}
